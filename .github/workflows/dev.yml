# https://dev.to/dyarleniber/setting-up-a-ci-cd-workflow-on-github-actions-for-a-react-app-with-github-pages-and-codecov-4hnp

name: deploy to dev server
on:
  push:
    branches: [ develop ]

jobs:
  build-dev:
    runs-on: ubuntu-latest
    environment:
      name: dev
    steps:

    - name: ä½¿ç”¨ node 16.15.0
      uses: actions/setup-node@v3
      with:
        node-version: '16.15.0'

    - name: ä¸‹è¼‰ç¨‹å¼ç¢¼ & ä¸‹è¼‰ submodules
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: å»ºç«‹å¿«ç…§ (node_modules)
      uses: actions/cache@v3
      with:
        path: |
          **/node_modules
        key: ${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

    - name: å®‰è£ node å¥—ä»¶
      run: npm i

    - name: çµ¦äºˆç’°å¢ƒè®Šæ•¸
      run: |
        touch .env
        echo "DATABASE_URL=${{secrets.DATABASE_URL}}" >> .env
        echo "MAP8_KEY=${{secrets.MAP8_KEY}}" >> .env
        echo "SESSION_SECRET=${{secrets.SESSION_SECRET}}" >> .env
        echo "REDIS_URL=${{secrets.REDIS_URL}}" >> .env
        echo "LINE_ACCESS_TOKEN=${{secrets.LINE_ACCESS_TOKEN}}" >> .env
        echo "LINE_CHANNEL_SECRET=${{secrets.LINE_CHANNEL_SECRET}}" >> .env
        echo "DOMAIN=${{secrets.DOMAIN}}" >> .env
        cat .env

    # - name: è·‘å€‹æ¸¬è©¦å”„
    #   run: npm test -- --coverage --watchAll=false -u

    - name: æ‰“åŒ…
      run: npm run build

    # - name: æ‰“åŒ…
    #   uses: nick-invision/retry@v2
    #   with:
    #     timeout_minutes: 10
    #     max_attempts: 3
    #     command: npm run build
    
    - name: å£“ç¸® build è³‡æ–™å¤¾
      uses: TonyBogdanov/zip@1.0
      with:
        args: zip -qq -r ./build.zip ./build ./public .env

    - name: ä¸Šå‚³ build ğŸ†™
      uses: actions/upload-artifact@v3
      with:
        name: build
        path: |
          build.zip

  deploy-dev: # éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: build-dev
    steps:
      - name: ä¸‹è¼‰ build.zip è³‡æ–™å¤¾ ğŸ†™
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: è§£å£“ build.zip è³‡æ–™å¤¾
        uses: TonyBogdanov/zip@1.0
        with:
          args: unzip -qq ./build.zip -d ./

      - name: ä¸Šå‚³ç¨‹å¼ç¢¼åˆ°server
        uses: appleboy/scp-action@master
        env:
          HOST: ${{secrets.HOST}}
          USERNAME: ${{secrets.USER}}
          PORT: 22
          KEY: ${{ secrets.KEY }}
        with:
          source: "./,!.git,!build.zip"
          target: "~/web/awmr-2-dev"

      # - name: æ”¹ä¸€ä¸‹ä½ç½®å”„
      #   uses: garygrossgarten/github-action-ssh@release
      #   with:
      #     command: |
      #       cd web
      #       mv awmr-2-dev trash
      #       mv trash/build .
      #       mv trash/package.json ./build
      #       mv trash/node_modules ./build
      #       mv build awmr-2-dev
      #       rm -rf ./trash
      #       chmod -R 775 awmr-2-dev
      #     host: ${{secrets.HOST}}
      #     username: ${{secrets.USER}}
      #     privateKey: ${{ secrets.KEY }}

  # slack-notice: # é€šçŸ¥å•¦å¹¹
  #     runs-on: ubuntu-latest
  #     needs: deploy-dev
  #     steps:
  #       - name: é€šçŸ¥ Slack
  #         uses: 8398a7/action-slack@v3
  #         with:
  #           status: ${{ job.status }}
  #           author_name: ${{ job.status }}
  #           fields: workflow,message,author # default: repo,commit
  #           mention: here
  #           if_mention: failure,cancelled
  #         env:
  #           SLACK_WEBHOOK_URL: ${{ secrets.DEV_SLACK_WEBHOOK_URL }} # required
  #         if: always() # Pick up events even if the job fails or is canceled.
